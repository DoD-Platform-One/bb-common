suite: Route Tests for VirtualService Using Passthrough Gateway
templates:
  - templates/routes/render.yaml
set:
  render: true
values:
  - ./values/routes-simple-passthrough.yaml
capabilities:
  apiVersions:
    - networking.istio.io/v1
tests:
  - it: should create an a VirtualService with tls section instead of http and with default port of 8443
    documentSelector:
      path: metadata.name
      value: webapp
    asserts:
      - equal:
          path: spec.hosts[0]
          value: webapp.company.com
      - equal:
          path: spec.gateways[0]
          value: istio-gateway/passthrough-ingressgateway
      - equal:
          path: spec.tls[0].match[0].port
          value: 8443
      - equal:
          path: spec.tls[0].match[0].sniHosts[0]
          value: webapp.company.com
      - equal:
          path: spec.tls[0].route[0].destination.host
          value: webapp
      - equal:
          path: spec.tls[0].route[0].destination.port.number
          value: 8080
  - it: should create an a VirtualService with custom gatewayPort specified
    set:
      routes.inbound.webapp.passthrough.gatewayPort: 9443
    documentSelector:
      path: metadata.name
      value: webapp
    asserts:
      - equal:
          path: spec.hosts[0]
          value: webapp.company.com
      - equal:
          path: spec.gateways[0]
          value: istio-gateway/passthrough-ingressgateway
      - equal:
          path: spec.tls[0].match[0].port
          value: 9443