# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Istio Authorization Policies Tests
templates:
  - templates/network-policies/render.yaml
release:
  name: test
set:
  istio:
    authorizationPolicies:
      generateFromNetpol: true
  networkPolicies:
    enabled: true
    ingress:
      defaults:
        enabled: false
    egress:
      defaults:
        enabled: false
tests:
  - it: must not create authorization policies when disabled
    set:
      istio.authorizationPolicies.generateFromNetpol: false
      networkPolicies.ingress.to.myapp.from.k8s.admin-sa@admin/dashboard: true
    asserts:
      - hasDocuments:
          count: 1
      - documentSelector:
          path: kind
          value: NetworkPolicy
        isKind:
          of: NetworkPolicy

  - it: must create authorization policy from k8s with service account identity
    set:
      networkPolicies.ingress.to.myapp.from.k8s.admin-sa@admin/dashboard: true
    documentSelector:
      path: metadata.name
      value: allow-ingress-to-myapp-any-port-from-ns-admin-pod-dashboard-with-identity-admin-sa
    asserts:
      - equal:
          path: spec
          value:
            action: ALLOW
            rules:
              - from:
                  - source:
                      principals:
                        - cluster.local/ns/admin/sa/admin-sa
            selector:
              matchLabels:
                app.kubernetes.io/name: myapp

  - it: must create authorization policy with specific port
    set:
      networkPolicies.ingress.to.myapp:8443.from.k8s.admin-sa@admin/dashboard: true
    documentSelector:
      path: metadata.name
      value: allow-ingress-to-myapp-tcp-port-8443-from-ns-admin-pod-dashboard-with-identity-admin-sa
    asserts:
      - equal:
          path: spec
          value:
            action: ALLOW
            rules:
              - to:
                  - operation:
                      ports:
                        - "8443"
                from:
                  - source:
                      principals:
                        - cluster.local/ns/admin/sa/admin-sa
            selector:
              matchLabels:
                app.kubernetes.io/name: myapp

  - it: must create authorization policy with port range expanded
    set:
      networkPolicies.ingress.to.myapp:50000-50002.from.k8s.grpc-sa@services/grpc-client: true
    documentSelector:
      path: metadata.name
      value: allow-ingress-to-myapp-tcp-ports-50000-thru-50002-from-ns-services-pod-grpc-client-with-identity-grpc-sa
    asserts:
      - equal:
          path: spec
          value:
            action: ALLOW
            rules:
              - to:
                  - operation:
                      ports:
                        - "50000"
                        - "50001"
                        - "50002"
                from:
                  - source:
                      principals:
                        - cluster.local/ns/services/sa/grpc-sa
            selector:
              matchLabels:
                app.kubernetes.io/name: myapp

  - it: must create authorization policy for k8s namespace without identity
    set:
      networkPolicies.ingress.to.myapp:8443.from.k8s.admin/dashboard: true
    asserts:
      - hasDocuments:
          count: 2
      - documentSelector:
          path: kind
          value: NetworkPolicy
        isKind:
          of: NetworkPolicy
      - documentSelector:
          path: kind
          value: AuthorizationPolicy
        equal:
          path: spec
          value:
            action: ALLOW
            rules:
              - from:
                  - source:
                      namespaces:
                        - admin
                to:
                  - operation:
                      ports:
                        - "8443"
            selector:
              matchLabels:
                app.kubernetes.io/name: myapp

  - it: must create authorization policy with selector override
    set:
      networkPolicies.ingress.to.myapp:8443:
        podSelector:
          matchLabels:
            app: myapp-specific
            version: v2
        from:
          k8s:
            admin-sa@admin/dashboard: true
    asserts:
      - hasDocuments:
          count: 2
      - documentSelector:
          path: kind
          value: AuthorizationPolicy
        equal:
          path: spec
          value:
            action: ALLOW
            rules:
              - to:
                  - operation:
                      ports:
                        - "8443"
                from:
                  - source:
                      principals:
                        - cluster.local/ns/admin/sa/admin-sa
            selector:
              matchLabels:
                app: myapp-specific
                version: v2

  - it: must create authorization policy from CIDR with specific port
    set:
      networkPolicies.ingress.to.myapp:8080.from.cidr:
        192.168.1.0/24: true
    asserts:
      - hasDocuments:
          count: 2
      - documentSelector:
          path: kind
          value: NetworkPolicy
        isKind:
          of: NetworkPolicy
      - documentSelector:
          path: kind
          value: AuthorizationPolicy
        equal:
          path: spec
          value:
            action: ALLOW
            rules:
              - from:
                  - source:
                      ipBlocks:
                        - 192.168.1.0/24
                to:
                  - operation:
                      ports:
                        - "8080"
            selector:
              matchLabels:
                app.kubernetes.io/name: myapp

  - it: must create authorization policy from CIDR without port
    set:
      networkPolicies.ingress.to.myapp.from.cidr:
        10.0.0.0/8: true
    asserts:
      - hasDocuments:
          count: 2
      - documentSelector:
          path: kind
          value: AuthorizationPolicy
        equal:
          path: spec
          value:
            action: ALLOW
            rules:
              - from:
                  - source:
                      ipBlocks:
                        - 10.0.0.0/8
            selector:
              matchLabels:
                app.kubernetes.io/name: myapp

  - it: must create authorization policy from anywhere (0.0.0.0/0)
    set:
      networkPolicies.ingress.to.myapp:3000.from.cidr:
        0.0.0.0/0: true
    asserts:
      - hasDocuments:
          count: 2
      - documentSelector:
          path: kind
          value: AuthorizationPolicy
        equal:
          path: metadata.name
          value: allow-ingress-to-myapp-tcp-port-3000-from-anywhere
      - documentSelector:
          path: kind
          value: AuthorizationPolicy
        equal:
          path: spec
          value:
            action: ALLOW
            rules:
              - from:
                  - source:
                      ipBlocks:
                        - 0.0.0.0/0
                to:
                  - operation:
                      ports:
                        - "3000"
            selector:
              matchLabels:
                app.kubernetes.io/name: myapp

  - it: must create authorization policy from CIDR with port range
    set:
      networkPolicies.ingress.to.myapp:9000-9002.from.cidr:
        172.16.0.0/12: true
    asserts:
      - hasDocuments:
          count: 2
      - documentSelector:
          path: kind
          value: AuthorizationPolicy
        equal:
          path: spec
          value:
            action: ALLOW
            rules:
              - from:
                  - source:
                      ipBlocks:
                        - 172.16.0.0/12
                to:
                  - operation:
                      ports:
                        - "9000"
                        - "9001"
                        - "9002"
            selector:
              matchLabels:
                app.kubernetes.io/name: myapp

