# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Istio Sidecar Tests
templates:
  - templates/istio/render.yaml
release:
  name: test
  namespace: test-namespace
tests:
  - it: should not create Sidecar when istio is disabled
    set:
      istio.enabled: false
      istio.sidecar.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create Sidecar when sidecar is disabled (but creates PeerAuth)
    set:
      istio.enabled: true
      istio.sidecar.enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PeerAuthentication

  - it: should create both Sidecar and PeerAuthentication when istio and sidecar are enabled
    set:
      istio.enabled: true
      istio.sidecar.enabled: true
    asserts:
      - hasDocuments:
          count: 2
      - documentIndex: 0
        isKind:
          of: Sidecar
      - documentIndex: 0
        equal:
          path: apiVersion
          value: networking.istio.io/v1
      - documentIndex: 0
        equal:
          path: metadata.name
          value: test-sidecar
      - documentIndex: 0
        equal:
          path: metadata.namespace
          value: test-namespace
      - documentIndex: 0
        equal:
          path: spec.outboundTrafficPolicy.mode
          value: REGISTRY_ONLY
      - documentIndex: 1
        isKind:
          of: PeerAuthentication

  - it: should use custom outboundTrafficPolicyMode when specified
    set:
      istio.enabled: true
      istio.sidecar.enabled: true
      istio.sidecar.outboundTrafficPolicyMode: ALLOW_ANY
    asserts:
      - hasDocuments:
          count: 2
      - documentIndex: 0
        equal:
          path: spec.outboundTrafficPolicy.mode
          value: ALLOW_ANY
