# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: Istio PeerAuthentication Tests
templates:
  - templates/istio/render.yaml
release:
  name: test
  namespace: test-namespace
tests:
  - it: should not create PeerAuthentication when istio is disabled
    set:
      istio.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create PeerAuthentication when istio is enabled
    set:
      istio.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PeerAuthentication
      - equal:
          path: apiVersion
          value: security.istio.io/v1
      - equal:
          path: metadata.name
          value: default-peer-auth
      - equal:
          path: metadata.namespace
          value: test-namespace
      - equal:
          path: spec.mtls.mode
          value: STRICT

  - it: should use custom mtls mode when specified
    set:
      istio.enabled: true
      istio.mtls.mode: PERMISSIVE
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.mtls.mode
          value: PERMISSIVE

  - it: should create both Sidecar and PeerAuthentication when both conditions are met
    set:
      istio.enabled: true
      istio.sidecar.enabled: true
    asserts:
      - hasDocuments:
          count: 2
      - documentIndex: 0
        isKind:
          of: Sidecar
      - documentIndex: 1
        isKind:
          of: PeerAuthentication
