# Istio Resources

BB-Common provides base Istio resources to secure and configure service mesh behavior for your applications.

## Overview

When Istio is enabled, BB-Common creates foundational security and networking resources:

- **PeerAuthentication**: Enforces mutual TLS between services
- **Sidecar**: Controls outbound traffic policy (when enabled)
- **AuthorizationPolicies**: Implements service-to-service authorization (see [Authorization Policies](../authorization-policies/README.md))
- **Custom Resources**: Allows end users to define application-specific ServiceEntries and AuthorizationPolicies for last-mile configuration

## Configuration

### Basic Configuration

```yaml
istio:
  enabled: true
```

## Resources Created

### NetworkPolicy

Creates a network policy that allows kubelet to contact readiness probes when operting in ambient mode. Please refer to [this link](https://istio.io/latest/docs/ambient/usage/networkpolicy/) for additional information/justification.

**Resource Name**: `default-ingress-allow-ambient-kubelet`

**Configuration**:

```yaml
istio:
  ambient:
    enabled: true
```

### PeerAuthentication

Enforces mutual TLS (mTLS) for service-to-service communication within the namespace.

**Resource Name**: `default-peer-auth`

**Default Mode**: `STRICT`

**Configuration**:

```yaml
istio:
  enabled: true
  mtls:
    mode: STRICT  # Options: STRICT, PERMISSIVE, DISABLE
```

### Sidecar

When enabled, creates a Sidecar resource that restricts outbound traffic to only services registered in the Istio service registry.

> **Note**: The Sidecar resource is separate from the Sidecar dataplane mode and is not applicable when using Ambient mode.

**Resource Name**: `{{ .Release.Name }}-sidecar`

**Default Outbound Policy**: `REGISTRY_ONLY`

**Configuration**:

```yaml
istio:
  enabled: true
  sidecar:
    enabled: true
    outboundTrafficPolicyMode: REGISTRY_ONLY  # Options: REGISTRY_ONLY, ALLOW_ANY
```

The `REGISTRY_ONLY` mode prevents sidecars from accessing external services that are not explicitly defined in the mesh, providing defense-in-depth security.

## Custom Resources

BB-Common allows you to define custom Istio resources for last-mile configuration. These are typically used by end users to add application-specific Istio resources that complement the base resources generated by BB-Common.

### Custom ServiceEntries

ServiceEntries allow you to add external services to the Istio service registry, making them accessible from within the mesh. This is commonly used to:

- Define external databases, APIs, or third-party services
- Enable egress traffic to specific external hosts when using `REGISTRY_ONLY` mode
- Configure DNS resolution and TLS settings for external services

**Configuration**:

```yaml
istio:
  enabled: true
  sidecar:
    enabled: true
  serviceEntries:
    custom:
      - name: external-database
        labels:
          app: myapp
          environment: production
        annotations:
          description: "External PostgreSQL database"
        spec:
          hosts:
            - postgres.example.com
          ports:
            - number: 5432
              name: tcp-postgres
              protocol: TCP
          location: MESH_EXTERNAL
          resolution: DNS

      - name: external-api
        spec:
          hosts:
            - api.partner.com
          ports:
            - number: 443
              name: https
              protocol: HTTPS
          location: MESH_EXTERNAL
          resolution: DNS
```

### Custom AuthorizationPolicies

Custom AuthorizationPolicies allow you to define fine-grained access control rules beyond what's automatically generated from NetworkPolicies. Common use cases include:

- Deny rules for specific operations or paths
- Complex authorization logic based on JWT claims or request attributes
- Layer 7 (HTTP/gRPC) authorization rules
- Allow/deny rules for specific workloads

**Configuration**:

```yaml
istio:
  enabled: true
  authorizationPolicies:
    enabled: true
    custom:
      - name: deny-admin-paths
        labels:
          security-level: high
        annotations:
          owner: security-team
        spec:
          selector:
            matchLabels:
              app: web-frontend
          action: DENY
          rules:
            - to:
                - operation:
                    paths:
                      - "/admin/*"
                      - "/internal/*"

      - name: allow-metrics-scraping
        spec:
          selector:
            matchLabels:
              app: myapp
          action: ALLOW
          rules:
            - from:
                - source:
                    namespaces:
                      - monitoring
              to:
                - operation:
                    paths:
                      - "/metrics"
                    methods:
                      - "GET"
```

### Configuration Options

Both custom resource types support:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Name of the resource |
| `labels` | object | No | Additional labels for the resource |
| `annotations` | object | No | Annotations for the resource |
| `spec` | object | Yes | Full Istio resource spec (see Istio documentation) |

**Notes**:
- All resources in the list are always created (no enable/disable toggle)
- Custom resources are rendered alongside BB-Common's base Istio resources
- Resources are deployed to the same namespace as the Helm release
- The `spec` field accepts the full Istio resource specification

### Last-Mile Configuration Pattern

Custom resources are designed for **last-mile configuration** - allowing end users to add application-specific policies without modifying the base chart. This pattern enables:

1. **Chart maintainers** to provide secure defaults via BB-Common's base resources
2. **End users** to extend with application-specific requirements via custom resources
3. **Clean separation** between platform-level and application-level policies

**Example**: A platform team uses BB-Common to enforce mTLS and default-deny policies, while application teams add custom ServiceEntries for their specific external dependencies and custom AuthorizationPolicies for their HTTP path-based access control.

## Related Documentation

### BB-Common Documentation
- [Authorization Policies](../authorization-policies/README.md) - Service-to-service authorization

### Istio Documentation
- [Istio PeerAuthentication](https://istio.io/latest/docs/reference/config/security/peer_authentication/)
- [Istio Sidecar](https://istio.io/latest/docs/reference/config/networking/sidecar/)
- [Istio ServiceEntry](https://istio.io/latest/docs/reference/config/networking/service-entry/)
- [Istio AuthorizationPolicy](https://istio.io/latest/docs/reference/config/security/authorization-policy/)
